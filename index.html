<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ETF ALPHA MATRIX v11.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f4f7f6; margin: 0; }
        .tab-menu { display: flex; background: #333; padding: 10px; gap: 10px; }
        .tab-btn { padding: 10px 20px; color: #ccc; cursor: pointer; border: none; background: none; }
        .tab-btn.active { color: #fff; font-weight: bold; border-bottom: 2px solid #007bff; }
        .card { background: #fff; margin: 20px; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        .btn-analyze { background: #007bff; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        .alert-pdf { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 5px; color: #856404; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [activeTab, setActiveTab] = useState("A");
            const [list, setList] = useState([]);
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const API_BASE = "https://etf-data-collector.onrender.com/api";

            const fetchData = async () => {
                const res = await fetch(`${API_BASE}/data/${activeTab}`);
                const data = await res.json();
                setList(data.data || []);
            };

            useEffect(() => { fetchData(); }, [activeTab]);

            const runDeepAnalysis = async (item) => {
                setLoading(true);
                setResult({ status: "LOADING", message: "Geminiê°€ PDF í™•ì¸ ë° ì‹¤ì‹œê°„ API ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤..." });
                try {
                    const res = await fetch(`${API_BASE}/deep-analyze`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: item.ì¢…ëª©ëª… || item.name, code: item.ì¢…ëª©ì½”ë“œ || item.ticker })
                    });
                    const data = await res.json();
                    setResult(data);
                } catch (e) {
                    setResult({ status: "ERROR", message: "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." });
                } finally { setLoading(false); }
            };

            return (
                <div>
                    <div className="tab-menu">
                        {["A", "C", "E"].map(t => (
                            <button key={t} className={`tab-btn ${activeTab === t ? 'active' : ''}`} onClick={()=>setActiveTab(t)}>{t} ëª¨ë¸ ë¦¬ìŠ¤íŠ¸</button>
                        ))}
                    </div>

                    <div className="card">
                        <h3>ğŸ“Š {activeTab} ê·¸ë£¹ ë¶„ì„ ë°ì´í„° (ì •ì  íŒŒì¼)</h3>
                        <table>
                            <thead>
                                <tr><th>ì¢…ëª©ëª…</th><th>í˜„ì¬ê°€</th><th>ë“±ê¸‰</th><th>ì‹¬ì¸µ ë¶„ì„</th></tr>
                            </thead>
                            <tbody>
                                {list.map((item, i) => (
                                    <tr key={i}>
                                        <td>{item.ì¢…ëª©ëª… || item.name} ({item.ì¢…ëª©ì½”ë“œ || item.ticker})</td>
                                        <td>{Number(item.í˜„ì¬ê°€ || item.price_curr).toLocaleString()}</td>
                                        <td>{item.ë“±ê¸‰ || item.grade_score}</td>
                                        <td><button className="btn-analyze" onClick={()=>runDeepAnalysis(item)}>Gemini ì‹¬ì¸µë¶„ì„</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {result && (
                        <div className="card">
                            <h3>ğŸ” Gemini AI ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼ (CSV B/D + PDF ì—°ë™)</h3>
                            {result.status === "LOADING" && <p>â³ {result.message}</p>}
                            {result.status === "NEED_PDF" && <div className="alert-pdf">âš ï¸ <strong>PDF ë¯¸ê²€ì¶œ:</strong> {result.message}</div>}
                            {result.status === "SUCCESS" && <div style={{whiteSpace:'pre-wrap', lineHeight:'1.7'}}>{result.analysis}</div>}
                            {result.status === "ERROR" && <p style={{color:'red'}}>{result.message}</p>}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
