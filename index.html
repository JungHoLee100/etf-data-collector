<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ETF ALPHA MATRIX v11.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: #fff; }
        .container { padding: 25px; max-width: 1400px; margin: 0 auto; }
        .tab-btn { padding: 10px 25px; cursor: pointer; border: none; background: #eee; font-weight: bold; }
        .tab-btn.active { background: #007bff; color: white; }
        .card { border: 1px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #1a1a1a; color: white; padding: 12px; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        pre { white-space: pre-wrap; font-family: inherit; line-height: 1.7; font-size: 14px; }
        .btn-ai { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [isAuth, setIsAuth] = useState(false);
            const [pass, setPass] = useState("");
            const [view, setView] = useState("dashboard"); // dashboard, logs
            const [activeGroup, setActiveGroup] = useState("A");
            const [data, setData] = useState({static:{A:[],C:[],E:[]}, portfolio:{holdings:[]}, logs:[]});
            const [loading, setLoading] = useState(false);
            const [analysisResult, setAnalysisResult] = useState("");

            const API_BASE = "https://etf-data-collector.onrender.com/api";

            const init = async () => {
                const res = await fetch(`${API_BASE}/init`);
                setData(await res.json());
            };

            useEffect(() => { if(isAuth) init(); }, [isAuth]);

            const handleDeepAnalysis = async (item) => {
                setLoading(true);
                setAnalysisResult("ğŸ¤– Geminiê°€ ì‹¤ì‹œê°„ ìˆ˜ê¸‰(B) ë° PDF ë¦¬í¬íŠ¸ë¥¼ ëŒ€ì¡° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
                const res = await fetch(`${API_BASE}/deep-analyze`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: item.ticker || item.ì¢…ëª©ì½”ë“œ, name: item.name || item.ì¢…ëª©ëª… })
                });
                const result = await res.json();
                setAnalysisResult(result.analysis);
                setData(prev => ({...prev, logs: result.logs}));
                setLoading(false);
            };

            const downloadCSV = () => {
                const headers = "ë‚ ì§œ,ì¢…ëª©ëª…,ì½”ë“œ,ì¶”ì²œì „ëµ\n";
                const rows = data.logs.map(log => `${log.date},${log.name},${log.code},"${log.reason.substring(0,100)}..."`).join("\n");
                const blob = new Blob(["\ufeff" + headers + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "ETF_Recommendation_Logs.csv";
                link.click();
            };

            if (!isAuth) {
                return (
                    <div style={{height:'100vh', display:'flex', justifyContent:'center', alignItems:'center', background:'#121212'}}>
                        <div style={{background:'#fff', padding:'40px', borderRadius:'20px', textAlign:'center'}}>
                            <h2 style={{color:'#007bff'}}>ğŸ“¡ SYSTEM ACCESS</h2>
                            <input type="password" value={pass} onChange={(e)=>setPass(e.target.value)} onKeyPress={(e)=>e.key==='Enter' && pass==='sd*11070823' && setIsAuth(true)} style={{padding:'12px', width:'220px', textAlign:'center'}} placeholder="Password" />
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <header style={{display:'flex', justifyContent:'space-between', marginBottom:'30px', alignItems:'center'}}>
                        <h1 style={{color:'#007bff', margin:0}}>ğŸ“¡ ETF ALPHA MATRIX v11.0</h1>
                        <div>
                            <button className={`tab-btn ${view==='dashboard'?'active':''}`} onClick={()=>setView('dashboard')}>ëŒ€ì‹œë³´ë“œ</button>
                            <button className={`tab-btn ${view==='logs'?'active':''}`} onClick={()=>setView('logs')}>ëˆ„ì  ì¶”ì²œ ë¡œê·¸ ({data.logs.length})</button>
                        </div>
                    </header>

                    {view === 'dashboard' ? (
                        <div style={{display:'grid', gridTemplateColumns:'1.5fr 1fr', gap:'25px'}}>
                            <div>
                                <section className="card" style={{borderLeft:'6px solid #007bff'}}>
                                    <h3>ğŸ’¼ ë‚´ ìì‚° í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬</h3>
                                    <table>
                                        <thead>
                                            <tr><th>ì¢…ëª©ëª…(ì½”ë“œ)</th><th>ë§¤ì…ê°€</th><th>ìˆ˜ëŸ‰</th><th>í˜„ì¬ê°€</th><th>ìˆ˜ìµë¥ </th></tr>
                                        </thead>
                                        <tbody>
                                            {data.portfolio.holdings.map((h, i) => (
                                                <tr key={i}>
                                                    <td style={{fontWeight:'bold'}}>{h.name}({h.code})</td>
                                                    <td>{h.avg_price.toLocaleString()}</td>
                                                    <td>{h.quantity}</td>
                                                    <td>{h.manual_price.toLocaleString()}</td>
                                                    <td style={{color: h.manual_price > h.avg_price ? 'red' : 'blue', fontWeight:'bold'}}>{((h.manual_price/h.avg_price - 1)*100).toFixed(2)}%</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </section>

                                <section className="card">
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px'}}>
                                        <h3>ğŸš€ {activeGroup} ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸</h3>
                                        <div style={{display:'flex', gap:'5px'}}>
                                            {["A", "C", "E"].map(g => <button key={g} onClick={()=>setActiveGroup(g)} style={{padding:'5px 15px', background: activeGroup===g ? '#333' : '#eee', color: activeGroup===g?'#fff':'#333', border:'none', borderRadius:'4px'}}>{g}</button>)}
                                        </div>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr><th>ì¢…ëª©ëª…</th><th>í˜„ì¬ê°€</th><th>ë“±ê¸‰</th><th>ì‹¬ì¸µë¶„ì„</th></tr>
                                        </thead>
                                        <tbody>
                                            {data.static[activeGroup]?.slice(0, 20).map((item, i) => (
                                                <tr key={i}>
                                                    <td style={{textAlign:'left', fontWeight:'bold'}}>{item.ì¢…ëª©ëª… || item.name}</td>
                                                    <td>{(item.í˜„ì¬ê°€ || item.price_curr || 0).toLocaleString()}</td>
                                                    <td>{item.ë“±ê¸‰ || item.grade_score}</td>
                                                    <td><button className="btn-ai" onClick={()=>handleDeepAnalysis(item)}>Gemini</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </section>
                            </div>

                            <div>
                                <section className="card" style={{minHeight:'600px', background:'#f8f9fa'}}>
                                    <h3>ğŸ” Gemini AI ë¶„ì„ ê²°ê³¼ (B+D+PDF)</h3>
                                    <div style={{padding:'15px', background:'#fff', border:'1px solid #ddd', borderRadius:'8px', minHeight:'500px'}}>
                                        <pre>{analysisResult || "ë¦¬ìŠ¤íŠ¸ì—ì„œ [Gemini] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì •ë°€ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤."}</pre>
                                    </div>
                                </section>
                            </div>
                        </div>
                    ) : (
                        <div className="card">
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'20px'}}>
                                <h3>ğŸ“œ ëˆ„ì  ì¶”ì²œ ë¦¬í¬íŠ¸ ë¡œê·¸</h3>
                                <div style={{display:'flex', gap:'10px'}}>
                                    <button onClick={downloadCSV} style={{padding:'8px 15px'}}>ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
                                    <button style={{padding:'8px 15px', background:'#007bff', color:'#fff', border:'none', borderRadius:'5px'}}>ğŸ“Š í†µí•© ë¶„ì„ ì‹¤í–‰</button>
                                </div>
                            </div>
                            <table>
                                <thead style={{background:'#f4f4f4'}}>
                                    <tr><th>ë‚ ì§œ</th><th>ì¢…ëª©ëª…</th><th>ì½”ë“œ</th><th>ì „ëµ ìš”ì•½</th></tr>
                                </thead>
                                <tbody>
                                    {data.logs.map((log, i) => (
                                        <tr key={i}>
                                            <td>{log.date}</td>
                                            <td style={{fontWeight:'bold'}}>{log.name}</td>
                                            <td>{log.code}</td>
                                            <td style={{textAlign:'left'}}>{log.reason.substring(0, 100)}...</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
